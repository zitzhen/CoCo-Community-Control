# .github/workflows/sync-d1-to-json.yml
name: Sync Cloudflare D1 to JSON

on:
  schedule:
    # æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
    - cron: '0 * * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync-d1:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: Setup tools
        run: sudo apt-get install -y jq curl
        
      - name: Query D1 database
        env:
          ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_ID: ${{ secrets.CLOUDFLARE_D1_DATABASE_ID }}
          API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "ğŸ”„ å¼€å§‹æŸ¥è¯¢ Cloudflare D1 æ•°æ®åº“..."
          
          # æ‰§è¡Œ SQL æŸ¥è¯¢
          RESPONSE=$(curl -s -X POST \
            "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/d1/database/$DATABASE_ID/query" \
            -H "Authorization: Bearer $API_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "sql": "SELECT name, size, downloads, likes, collections, author FROM components ORDER BY name"
            }')
          
          # æ£€æŸ¥å“åº”æ˜¯å¦æˆåŠŸ
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" = "true" ]; then
            echo "âœ… D1 æŸ¥è¯¢æˆåŠŸ"
            
            # æå–æ•°æ®å¹¶ç”Ÿæˆ JSON æ–‡ä»¶
            echo "$RESPONSE" | jq '.result[0].results' | jq '{list: .}' > new_list.json
            
            # ç»Ÿè®¡æ•°æ®
            COUNT=$(jq '.list | length' new_list.json)
            echo "ğŸ“Š è·å–åˆ° $COUNT æ¡æ•°æ®"
            
            # æ˜¾ç¤ºå‰3æ¡æ•°æ®é¢„è§ˆ
            echo "ğŸ“‹ æ•°æ®é¢„è§ˆ:"
            jq '.list[0:3]' new_list.json
            
          else
            echo "âŒ D1 æŸ¥è¯¢å¤±è´¥"
            echo "$RESPONSE" | jq .
            exit 1
          fi
          
      - name: Check for changes
        id: check_changes
        run: |
          echo "ğŸ” æ£€æŸ¥æ•°æ®å˜åŒ–..."
          if [ ! -f list.json ]; then
            echo "ğŸ“ é¦–æ¬¡ç”Ÿæˆ list.json æ–‡ä»¶"
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          elif cmp -s new_list.json list.json; then
            echo "âœ… æ•°æ®æ— å˜åŒ–"
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“ æ£€æµ‹åˆ°æ•°æ®å˜åŒ–"
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "å·®å¼‚ç»Ÿè®¡:"
            OLD_COUNT=$(jq '.list | length' list.json 2>/dev/null || echo 0)
            NEW_COUNT=$(jq '.list | length' new_list.json)
            echo "åŸæ•°æ®: $OLD_COUNT æ¡ï¼Œæ–°æ•°æ®: $NEW_COUNT æ¡"
          fi
          
      - name: Update JSON file
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          mv new_list.json list.json
          echo "âœ… å·²æ›´æ–° list.json æ–‡ä»¶"
          echo "ğŸ• æ›´æ–°æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M UTC')"
          
      - name: Create Pull Request
        if: steps.check_changes.outputs.changes_detected == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: è‡ªåŠ¨åŒæ­¥ Cloudflare D1 æ•°æ® [$(date -u +'%Y-%m-%d %H:%M')]"
          title: "ğŸ”„ è‡ªåŠ¨åŒæ­¥: Cloudflare D1 æ•°æ®æ›´æ–°"
          body: |
            æ­¤ PR ç”±è‡ªåŠ¨åŒæ­¥å·¥ä½œæµåˆ›å»ºï¼ŒåŒ…å«æœ€æ–°çš„ Cloudflare D1 æ•°æ®åº“å†…å®¹ã€‚
            
            ## å˜æ›´è¯¦æƒ…
            - æ›´æ–°äº† `list.json` æ–‡ä»¶
            - æ•°æ®è¡¨: `components`
            - æ•°æ®è¡Œæ•°: $(jq '.list | length' list.json)
            
            **åŒæ­¥æ—¶é—´:** $(date -u +'%Y-%m-%d %H:%M UTC')  
            **è§¦å‘æ–¹å¼:** ${{ github.event.schedule && 'å®šæ—¶ä»»åŠ¡' || 'æ‰‹åŠ¨è§¦å‘' }}  
            **å·¥ä½œæµè¿è¡Œ:** [${{ github.workflow }} #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            > ğŸ”„ è‡ªåŠ¨åŒæ­¥ - ä»…åœ¨æ£€æµ‹åˆ°æ•°æ®å˜åŒ–æ—¶åˆ›å»º PR
          branch: "auto-sync/d1-data-$(date +%Y%m%d-%H%M%S)"
          delete-branch: true
          labels: "automated-pr,data-sync,d1"
          
      - name: Cleanup on no changes
        if: steps.check_changes.outputs.changes_detected == 'false'
        run: |
          rm -f new_list.json
          echo "âœ… æ•°æ®æ— å˜åŒ–ï¼Œå·²æ¸…ç†ä¸´æ—¶æ–‡ä»¶"
          echo "ğŸ• æ£€æŸ¥æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M UTC')"