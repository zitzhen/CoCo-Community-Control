name: Sync Cloudflare D1 to JSON

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  sync-d1:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup tools
        run: sudo apt-get install -y sqlite3 jq curl
        
      - name: Debug D1 export request
        env:
          ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_ID: ${{ secrets.CLOUDFLARE_D1_DATABASE_ID }}
          API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "è°ƒè¯• D1 å¯¼å‡ºè¯·æ±‚..."
          echo "è´¦æˆ· ID: $ACCOUNT_ID"
          echo "æ•°æ®åº“ ID: $DATABASE_ID"
          echo "API Token é•¿åº¦: ${#API_TOKEN}"
          
          # æµ‹è¯•å¯¼å‡º API
          RESPONSE=$(curl -s -X POST \
            "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/d1/database/$DATABASE_ID/export" \
            -H "Authorization: Bearer $API_TOKEN" \
            -H "Content-Type: application/json" \
            -w "\n%{http_code}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "HTTP çŠ¶æ€ç : $HTTP_CODE"
          echo "å“åº”å†…å®¹:"
          echo "$RESPONSE_BODY" | jq .
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ D1 å¯¼å‡ºè¯·æ±‚å¤±è´¥"
            exit 1
          fi
          
          # æå–ä¸‹è½½ URL
          DOWNLOAD_URL=$(echo "$RESPONSE_BODY" | jq -r '.result.url')
          echo "ä¸‹è½½ URL: $DOWNLOAD_URL"
          
          if [ "$DOWNLOAD_URL" = "null" ] || [ -z "$DOWNLOAD_URL" ]; then
            echo "âŒ æ— æ³•è·å–ä¸‹è½½ URLï¼Œå“åº”è¯¦æƒ…:"
            echo "$RESPONSE_BODY" | jq .
            exit 1
          fi
          
          echo "DOWNLOAD_URL=$DOWNLOAD_URL" >> $GITHUB_ENV
          
      - name: Download D1 database
        env:
          DOWNLOAD_URL: ${{ env.DOWNLOAD_URL }}
        run: |
          echo "ä¸‹è½½æ•°æ®åº“æ–‡ä»¶..."
          wget -O database.sqlite "$DOWNLOAD_URL"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸‹è½½æˆåŠŸ
          if [ ! -f database.sqlite ] || [ ! -s database.sqlite ]; then
            echo "âŒ æ•°æ®åº“æ–‡ä»¶ä¸‹è½½å¤±è´¥æˆ–ä¸ºç©º"
            exit 1
          fi
          
          echo "âœ… æ•°æ®åº“æ–‡ä»¶ä¸‹è½½æˆåŠŸ"
          ls -la database.sqlite
          
      - name: Extract data from SQLite
        run: |
          echo "ä» SQLite æå–æ•°æ®..."
          
          # æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
          if ! sqlite3 database.sqlite ".tables" | grep -q components; then
            echo "âŒ æ•°æ®åº“ä¸­ä¸å­˜åœ¨ 'components' è¡¨"
            sqlite3 database.sqlite ".tables"
            exit 1
          fi
          
          # æ£€æŸ¥è¡¨ç»“æ„
          echo "è¡¨ç»“æ„:"
          sqlite3 database.sqlite ".schema components"
          
          # æ£€æŸ¥æ•°æ®è¡Œæ•°
          COUNT=$(sqlite3 database.sqlite "SELECT COUNT(*) FROM components")
          echo "æ•°æ®è¡Œæ•°: $COUNT"
          
          # æå–æ•°æ®ç”Ÿæˆ JSON
          sqlite3 database.sqlite "
            SELECT json_group_array(json_object(
              'name', name,
              'size', size,
              'Downloads', downloads,
              'Likes', likes,
              'Collections', collections,
              'Author', author
            )) FROM components ORDER BY name;
          " | jq '{list: .}' > new_list.json
          
          echo "âœ… æ•°æ®æå–å®Œæˆ"
          echo "ç”Ÿæˆçš„ JSON æ–‡ä»¶å¤§å°: $(wc -c < new_list.json) å­—èŠ‚"
          
      - name: Check for changes
        id: changes
        run: |
          echo "æ£€æŸ¥æ•°æ®å˜åŒ–..."
          if [ ! -f list.json ]; then
            echo "ğŸ“ é¦–æ¬¡ç”Ÿæˆ list.json"
            echo "changed=true" >> $GITHUB_OUTPUT
          elif cmp -s new_list.json list.json; then
            echo "âœ… æ•°æ®æ— å˜åŒ–"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“ æ£€æµ‹åˆ°æ•°æ®å˜åŒ–"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
          
      - name: Update JSON file
        if: steps.changes.outputs.changed == 'true'
        run: |
          mv new_list.json list.json
          echo "âœ… å·²æ›´æ–° list.json"
          echo "é¢„è§ˆå‰3æ¡æ•°æ®:"
          jq '.list[0:3]' list.json
          
      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: è‡ªåŠ¨åŒæ­¥ Cloudflare D1 æ•°æ®"
          title: "ğŸ”„ è‡ªåŠ¨åŒæ­¥: Cloudflare D1 æ•°æ®æ›´æ–°"
          body: |
            è‡ªåŠ¨åŒæ­¥ Cloudflare D1 æ•°æ®åº“å†…å®¹åˆ° JSON æ–‡ä»¶ã€‚
            
            **åŒæ­¥æ—¶é—´:** $(date -u +'%Y-%m-%d %H:%M UTC')
            **æ•°æ®è¡Œæ•°:** $(sqlite3 database.sqlite "SELECT COUNT(*) FROM components" 2>/dev/null || echo "N/A")
          branch: "auto-sync/d1-$(date +%s)"
          delete-branch: true
          
      - name: Cleanup
        if: always()
        run: rm -f database.sqlite new_list.json