# .github/workflows/sync-d1-to-json.yml
name: Sync Cloudflare D1 to JSON

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  sync-d1:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup tools
        run: sudo apt-get install -y sqlite3 jq curl
        
      - name: Test API token permissions
        env:
          ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "æµ‹è¯• API Token æƒé™..."
          
          # æµ‹è¯•åŸºæœ¬çš„è´¦æˆ·è®¿é—®æƒé™
          RESPONSE=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID" \
            -H "Authorization: Bearer $API_TOKEN" \
            -H "Content-Type: application/json" \
            -w "\n%{http_code}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "è´¦æˆ·ä¿¡æ¯è¯·æ±‚çŠ¶æ€ç : $HTTP_CODE"
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… API Token åŸºæœ¬æƒé™æ­£å¸¸"
            echo "è´¦æˆ·åç§°: $(echo "$RESPONSE_BODY" | jq -r '.result.name // "æœªçŸ¥"')"
          else
            echo "âŒ API Token æ— æ³•è®¿é—®è´¦æˆ·"
            echo "$RESPONSE_BODY" | jq .
            exit 1
          fi
          
      - name: List D1 databases
        env:
          ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "è·å– D1 æ•°æ®åº“åˆ—è¡¨..."
          
          RESPONSE=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/d1/database" \
            -H "Authorization: Bearer $API_TOKEN" \
            -H "Content-Type: application/json" \
            -w "\n%{http_code}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "D1 åˆ—è¡¨è¯·æ±‚çŠ¶æ€ç : $HTTP_CODE"
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… æˆåŠŸè·å– D1 æ•°æ®åº“åˆ—è¡¨"
            echo "æ•°æ®åº“åˆ—è¡¨:"
            echo "$RESPONSE_BODY" | jq -r '.result[] | "\(.name) - \(.uuid)"'
          else
            echo "âŒ æ— æ³•è·å– D1 æ•°æ®åº“åˆ—è¡¨"
            echo "$RESPONSE_BODY" | jq .
            exit 1
          fi
          
      - name: Query D1 data directly
        env:
          ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_ID: ${{ secrets.CLOUDFLARE_D1_DATABASE_ID }}
          API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "ç›´æ¥æŸ¥è¯¢ D1 æ•°æ®ï¼ˆä¸ä½¿ç”¨å¯¼å‡ºåŠŸèƒ½ï¼‰..."
          
          # ä½¿ç”¨ D1 æŸ¥è¯¢ API è€Œä¸æ˜¯å¯¼å‡º API
          RESPONSE=$(curl -s -X POST \
            "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/d1/database/$DATABASE_ID/query" \
            -H "Authorization: Bearer $API_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "sql": "SELECT name, size, downloads, likes, collections, author FROM components ORDER BY name"
            }' \
            -w "\n%{http_code}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "æŸ¥è¯¢è¯·æ±‚çŠ¶æ€ç : $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ]; then
            SUCCESS=$(echo "$RESPONSE_BODY" | jq -r '.success')
            if [ "$SUCCESS" = "true" ]; then
              echo "âœ… D1 æŸ¥è¯¢æˆåŠŸ"
              
              # æå–æ•°æ®å¹¶ç”Ÿæˆ JSON
              echo "$RESPONSE_BODY" | jq '.result[0].results' | jq '{list: .}' > new_list.json
              
              echo "æ•°æ®è¡Œæ•°: $(jq '.list | length' new_list.json)"
              echo "é¢„è§ˆæ•°æ®:"
              jq '.list[0:3]' new_list.json
            else
              echo "âŒ D1 æŸ¥è¯¢è¿”å›å¤±è´¥"
              echo "$RESPONSE_BODY" | jq .
              exit 1
            fi
          else
            echo "âŒ D1 æŸ¥è¯¢è¯·æ±‚å¤±è´¥"
            echo "$RESPONSE_BODY" | jq .
            exit 1
          fi
          
      - name: Check for changes
        id: changes
        run: |
          echo "æ£€æŸ¥æ•°æ®å˜åŒ–..."
          if [ ! -f list.json ]; then
            echo "ğŸ“ é¦–æ¬¡ç”Ÿæˆ list.json"
            echo "changed=true" >> $GITHUB_OUTPUT
          elif cmp -s new_list.json list.json; then
            echo "âœ… æ•°æ®æ— å˜åŒ–"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“ æ£€æµ‹åˆ°æ•°æ®å˜åŒ–"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
          
      - name: Update JSON file
        if: steps.changes.outputs.changed == 'true'
        run: |
          mv new_list.json list.json
          echo "âœ… å·²æ›´æ–° list.json"
          
      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: è‡ªåŠ¨åŒæ­¥ Cloudflare D1 æ•°æ®"
          title: "ğŸ”„ è‡ªåŠ¨åŒæ­¥: Cloudflare D1 æ•°æ®æ›´æ–°"
          body: |
            è‡ªåŠ¨åŒæ­¥ Cloudflare D1 æ•°æ®åº“å†…å®¹åˆ° JSON æ–‡ä»¶ã€‚
            
            **åŒæ­¥æ—¶é—´:** $(date -u +'%Y-%m-%d %H:%M UTC')
            **æ•°æ®è¡Œæ•°:** $(jq '.list | length' list.json)
          branch: "auto-sync/d1-$(date +%s)"
          delete-branch: true
          
      - name: Cleanup
        if: always()
        run: rm -f new_list.json