name: Sync D1 Data

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq curl gh

      - name: Fetch and update D1 data
        env:
          ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_ID: ${{ secrets.CLOUDFLARE_D1_DATABASE_ID }}
          API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "ğŸ“¦ æ­£åœ¨ä» Cloudflare D1 è·å–æ•°æ®..."
          curl -s -X POST \
            "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/d1/database/$DATABASE_ID/query" \
            -H "Authorization: Bearer $API_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"sql":"SELECT * FROM components"}' | \
          jq '.result[0].results' | jq '{list: .}' > list.json

          if [ "$(jq '.list | length' list.json)" -eq 0 ]; then
            echo "âœ… æ²¡æœ‰ä»»ä½•å¯æ¯”è¾ƒçš„å†…å®¹ï¼Œè¿è¡Œæ­£å¸¸ï¼Œç»“æŸå·¥ä½œæµã€‚"
            exit 0
          fi

      - name: Compare and push changes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

          BRANCH="d1-sync"
          git fetch origin
          git checkout -B "$BRANCH" "origin/$BRANCH" || git checkout -B "$BRANCH"

          OLD_FILE_EXISTS=0
          if git ls-tree -r origin/main --name-only | grep -q '^list.json$'; then
            git show origin/main:list.json > old_list.json
            OLD_FILE_EXISTS=1
          fi

          if [ "$OLD_FILE_EXISTS" -eq 1 ] && cmp -s old_list.json list.json; then
            echo "âœ… list.json ä¸ origin/main ç›¸åŒï¼Œæš‚æ— å˜åŒ–ï¼Œç»“æŸå·¥ä½œæµã€‚"
            exit 0
          fi

          git add list.json
          if git diff --cached --quiet; then
            echo "âœ… æ²¡æœ‰æ–‡ä»¶å˜åŒ–å¯æäº¤ï¼Œç»“æŸå·¥ä½œæµã€‚"
            exit 0
          fi

          git commit -m "chore: sync D1 data ($(date +%Y-%m-%d))"
          git pull origin "$BRANCH" --rebase || echo "âš ï¸ rebase å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶æ¨é€"
          git push origin "$BRANCH" || git push origin "$BRANCH" --force-with-lease

      - name: Wait for branch sync
        run: sleep 5

      - name: Create or update Pull Request (with label)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="d1-sync"
          LABEL="CloudflareD1 auto-sync"

          echo "ğŸª„ æ£€æŸ¥æ˜¯å¦å·²æœ‰ PR..."
          EXISTING_PR=$(gh pr list --head "$BRANCH" --state open --json number --jq '.[0].number')

          echo "ğŸ” æ£€æŸ¥ä¸ main çš„å·®å¼‚..."
          if [ "$(git rev-list origin/main..origin/$BRANCH | wc -l)" -eq 0 ]; then
            echo "âœ… main ä¸ $BRANCH æ²¡æœ‰ä»»ä½•å·®å¼‚ï¼Œè·³è¿‡ PR åˆ›å»ºã€‚"
            exit 0
          fi

          if [ -n "$EXISTING_PR" ]; then
            echo "ğŸ”„ å·²å­˜åœ¨ PR #$EXISTING_PRï¼Œæ›´æ–°åˆ†æ”¯å®Œæˆã€‚"
            gh pr edit "$EXISTING_PR" --add-label "$LABEL" || echo "âš ï¸ æ— æ³•æ·»åŠ æ ‡ç­¾ï¼Œå¯èƒ½æ ‡ç­¾ä¸å­˜åœ¨ã€‚"
          else
            echo "âœ¨ åˆ›å»ºæ–°çš„ PR..."
            gh pr create \
              --title "Update D1 data ($(date +%Y-%m-%d))" \
              --body "Automated data sync from Cloudflare D1. I need @Iamliuxiaozhen to handle this pull request." \
              --base main \
              --head "$BRANCH"

            NEW_PR=$(gh pr list --head "$BRANCH" --state open --json number --jq '.[0].number')
            if [ -n "$NEW_PR" ]; then
              echo "ğŸ·ï¸ ä¸ºæ–° PR #$NEW_PR æ·»åŠ æ ‡ç­¾ $LABEL"
              gh pr edit "$NEW_PR" --add-label "$LABEL" || echo "âš ï¸ æ— æ³•æ·»åŠ æ ‡ç­¾ï¼Œå¯èƒ½æ ‡ç­¾ä¸å­˜åœ¨ã€‚"

              echo "âœ¨ è‡ªåŠ¨åˆå¹¶ PR #$NEW_PR..."
              gh pr merge "$NEW_PR" --squash --auto || echo "âš ï¸ æ— æ³•è®¾ç½®è‡ªåŠ¨åˆå¹¶"
            fi
          fi

      - name: Auto-merge existing PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="d1-sync"
          EXISTING_PR=$(gh pr list --head "$BRANCH" --state open --json number --jq '.[0].number')
          
          if [ -n "$EXISTING_PR" ]; then
            echo "âœ¨ å°è¯•è‡ªåŠ¨åˆå¹¶ç°æœ‰ PR #$EXISTING_PR..."
            gh pr merge "$EXISTING_PR" --squash --auto || echo "âš ï¸ PR å¯èƒ½å·²è®¾ç½®è‡ªåŠ¨åˆå¹¶æˆ–å­˜åœ¨æ£€æŸ¥æœªå®Œæˆ"
          fi

      - name: Delete branch after merge
        if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="d1-sync"
          PR_INFO=$(gh pr list --head "$BRANCH" --state closed --json mergedAt,number --jq '.[0]')
          if [ -n "$PR_INFO" ]; then
            echo "ğŸ§¹ PR å·²åˆå¹¶ï¼Œå°è¯•åˆ é™¤åˆ†æ”¯ $BRANCH..."
            gh api -X DELETE /repos/${{ github.repository }}/git/refs/heads/$BRANCH || echo "âš ï¸ åˆ é™¤å¤±è´¥ï¼Œå¯èƒ½åˆ†æ”¯å·²ä¸å­˜åœ¨"
          else
            echo "â„¹ï¸ PR å°šæœªåˆå¹¶ï¼Œè·³è¿‡åˆ é™¤åˆ†æ”¯ã€‚"
          fi