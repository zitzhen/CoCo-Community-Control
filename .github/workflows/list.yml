# .github/workflows/sync-d1-to-json.yml
name: Sync Cloudflare D1 to JSON

on:
  schedule:
    # æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
    - cron: '0 * * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync-d1:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Setup SQLite
      run: |
        sudo apt-get update
        sudo apt-get install -y sqlite3 jq
        
    - name: Download D1 database
      run: |
        # ä½¿ç”¨ Cloudflare API å¯¼å‡ºæ•´ä¸ª D1 æ•°æ®åº“
        curl -X POST \
          "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/d1/database/${{ secrets.CLOUDFLARE_D1_DATABASE_ID }}/export" \
          -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          --output d1_export.json
        
        # ä»å“åº”ä¸­è·å–ä¸‹è½½ URL
        DOWNLOAD_URL=$(jq -r '.result.url' d1_export.json)
        
        # ä¸‹è½½ SQLite æ•°æ®åº“æ–‡ä»¶
        wget -O database.sqlite "$DOWNLOAD_URL"
        
    - name: Extract data and generate JSON
      run: |
        # ä» SQLite æ•°æ®åº“æŸ¥è¯¢æ•°æ®å¹¶ç”Ÿæˆ JSON
        sqlite3 database.sqlite "SELECT json_group_array(json_object(
          'name', name,
          'size', size,
          'Downloads', downloads,
          'Likes', likes,
          'Collections', collections,
          'Author', author
        )) FROM components;" | jq '{list: .}' > new_list.json
        
        # æ ¼å¼åŒ– JSON
        jq . new_list.json > formatted_new_list.json
        mv formatted_new_list.json new_list.json
        
    - name: Check for changes
      id: check_changes
      run: |
        # æ¯”è¾ƒæ–°ç”Ÿæˆçš„ JSON ä¸ç°æœ‰æ–‡ä»¶
        if cmp -s new_list.json list.json; then
          echo "changes_detected=false" >> $GITHUB_OUTPUT
          echo "âœ… æ²¡æœ‰æ£€æµ‹åˆ°æ•°æ®å˜åŒ–"
        else
          echo "changes_detected=true" >> $GITHUB_OUTPUT
          echo "ğŸ“ æ£€æµ‹åˆ°æ•°æ®å˜åŒ–"
          echo "å·®å¼‚:"
          diff -u list.json new_list.json || true
        fi
        
    - name: Update JSON file
      if: steps.check_changes.outputs.changes_detected == 'true'
      run: |
        mv new_list.json list.json
        echo "ğŸ”„ å·²æ›´æ–° list.json æ–‡ä»¶"
        
    - name: Create Pull Request
      if: steps.check_changes.outputs.changes_detected == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: è‡ªåŠ¨åŒæ­¥ Cloudflare D1 æ•°æ®"
        title: "ğŸ”„ è‡ªåŠ¨åŒæ­¥: Cloudflare D1 æ•°æ®æ›´æ–°"
        body: |
          æ­¤ PR ç”±è‡ªåŠ¨åŒæ­¥å·¥ä½œæµåˆ›å»ºï¼ŒåŒ…å«æœ€æ–°çš„ Cloudflare D1 æ•°æ®ã€‚
          
          ## å˜æ›´è¯¦æƒ…
          æ›´æ–°äº† `list.json` æ–‡ä»¶ä»¥åæ˜ æœ€æ–°çš„æ•°æ®åº“çŠ¶æ€ã€‚
          
          **åŒæ­¥æ—¶é—´:** ${{ fromJSON('["ğŸ•","ğŸ•‘","ğŸ•’","ğŸ•“","ğŸ•”","ğŸ••","ğŸ•–","ğŸ•—","ğŸ•˜","ğŸ•™","ğŸ•š","ğŸ•›"]')[github.run_attempt % 12] }} $(date -u +'%Y-%m-%d %H:%M UTC')
          **è§¦å‘æ–¹å¼:** ${{ github.event.schedule && 'å®šæ—¶ä»»åŠ¡' || 'æ‰‹åŠ¨è§¦å‘' }}
          
          > è‡ªåŠ¨ç”Ÿæˆ - æ•°æ®æœ‰å˜åŒ–æ—¶æ‰ä¼šåˆ›å»ºæ­¤ PR
        branch: "auto-sync/d1-data-$(date +%Y%m%d-%H%M%S)"
        delete-branch: true
        labels: "automated-pr,data-sync"
        
    - name: Cleanup
      if: always()
      run: |
        rm -f d1_export.json database.sqlite new_list.json