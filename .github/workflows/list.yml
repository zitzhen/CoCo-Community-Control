# .github/workflows/sync-d1-to-json.yml
name: Sync Cloudflare D1 to JSON

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  sync-d1:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup tools and prepare PR
        id: prep
        run: |
          sudo apt-get install -y jq curl
          # ç”Ÿæˆå”¯ä¸€åˆ†æ”¯å
          echo "branch_name=d1-sync-${{ github.run_id }}-${{ github.run_attempt }}" >> $GITHUB_OUTPUT
          echo "PR_TITLE=ğŸ”„ D1 Data Sync - $(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_OUTPUT
          
      - name: Query D1 database
        env:
          ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_ID: ${{ secrets.CLOUDFLARE_D1_DATABASE_ID }}
          API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "ğŸ”„ Querying Cloudflare D1 database..."
          
          RESPONSE=$(curl -s -X POST \
            "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/d1/database/$DATABASE_ID/query" \
            -H "Authorization: Bearer $API_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "sql": "SELECT name, size, downloads, likes, collections, author FROM components ORDER BY name"
            }')
          
          if echo "$RESPONSE" | jq -e '.success == true' > /dev/null; then
            echo "âœ… D1 query successful"
            echo "$RESPONSE" | jq '.result[0].results' | jq '{list: .}' > new_list.json
            COUNT=$(jq '.list | length' new_list.json)
            echo "ğŸ“Š Retrieved $COUNT records"
          else
            echo "âŒ D1 query failed"
            echo "$RESPONSE" | jq .
            exit 1
          fi
          
      - name: Check for changes
        id: changes
        run: |
          if [ ! -f list.json ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ First time generating list.json"
          elif cmp -s new_list.json list.json; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… No data changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ Data changes detected"
          fi
          
      - name: Update JSON file and create PR
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          # æ›´æ–°æ–‡ä»¶
          mv new_list.json list.json
          
          # é…ç½® Git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # åˆ›å»ºåˆ†æ”¯å¹¶æäº¤
          git checkout -b ${{ steps.prep.outputs.branch_name }}
          git add list.json
          git commit -m "chore: sync D1 data"
          
          # æ¨é€åˆ°è¿œç¨‹
          git push origin ${{ steps.prep.outputs.branch_name }}
          
          # åˆ›å»º PR
          gh pr create \
            --title "${{ steps.prep.outputs.PR_TITLE }}" \
            --body "Automated sync from Cloudflare D1 database" \
            --base main \
            --head ${{ steps.prep.outputs.branch_name }} \
            --label "automated-pr"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Cleanup on no changes
        if: steps.changes.outputs.has_changes == 'false'
        run: |
          rm -f new_list.json
          echo "âœ… No changes, cleanup completed"