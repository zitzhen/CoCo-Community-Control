# .github/workflows/sync-d1-to-json.yml
name: Sync Cloudflare D1 to JSON

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  sync-d1:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup tools
        run: sudo apt-get install -y sqlite3 jq curl
        
      - name: Export D1 data
        env:
          ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_ID: ${{ secrets.CLOUDFLARE_D1_DATABASE_ID }}
          API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          # å¯¼å‡º D1 æ•°æ®åº“
          curl -s -X POST \
            "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/d1/database/$DATABASE_ID/export" \
            -H "Authorization: Bearer $API_TOKEN" \
            -H "Content-Type: application/json" | jq -r '.result.url' | xargs wget -O database.sqlite
          
      - name: Generate JSON
        run: |
          sqlite3 database.sqlite "SELECT json_group_array(json_object(
            'name', name, 'size', size, 'Downloads', downloads, 
            'Likes', likes, 'Collections', collections, 'Author', author
          )) FROM components;" | jq '{list: .}' > new_list.json
          
      - name: Check changes
        id: changes
        run: |
          if [ -f list.json ] && cmp -s new_list.json list.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
            
      - name: Create PR
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: sync D1 data"
          title: "ðŸ”„ Update D1 data"
          branch: "auto-sync/d1-$(date +%s)"
          delete-branch: true